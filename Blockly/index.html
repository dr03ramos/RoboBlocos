<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RoboBlocos - Visual Programming</title>
    <script src="lib/blockly_compressed.js"></script>
    <script src="lib/blocks_compressed.js"></script>
    <script src="custom/nqc-generator.js"></script>
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #blocklyDiv {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="blocklyDiv"></div>

    <xml id="toolbox" style="display: none">
        <category name="Motores" colour="160">
            <block type="nqc_ligar_motor_com_potencia"></block>
            <block type="nqc_ligar_motor"></block>
            <block type="nqc_define_potencia_percent"></block>
            <block type="nqc_define_sentido"></block>
            <block type="nqc_toca_som"></block>
        </category>
        <category name="Sensores" colour="200">
            <block type="nqc_define_sensor_toque"></block>
            <block type="nqc_define_sensor_luz"></block>
            <block type="nqc_define_sensor_rotacao"></block>
            <block type="nqc_valor_sensor_toque"></block>
            <block type="nqc_valor_sensor_luz"></block>
            <block type="nqc_valor_sensor_rotacao"></block>
        </category>
        <category name="Controles" colour="120">
            <block type="nqc_espera_segundos">
                <value name="SECONDS">
                    <shadow type="nqc_numero">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="nqc_espera_ate_que"></block>
            <block type="nqc_repita_vezes">
                <value name="TIMES">
                    <shadow type="nqc_numero">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="nqc_repita_infinitamente"></block>
            <block type="nqc_repita_ate_que"></block>
        </category>
        <category name="Variáveis" colour="330">
            <block type="nqc_variavel_recebe"></block>
            <block type="nqc_valor_variavel"></block>
        </category>
        <category name="Matemática" colour="230">
            <block type="nqc_numero">
                <field name="NUM">0</field>
            </block>
            <block type="nqc_operacao_matematica"></block>
        </category>
        <category name="Lógica" colour="210">
            <block type="nqc_comparacao"></block>
            <block type="nqc_operacao_logica"></block>
            <block type="nqc_contrario"></block>
            <block type="nqc_booleano"></block>
        </category>
        <category name="Condicionais" colour="290">
            <block type="nqc_se_faca"></block>
            <block type="nqc_se_faca_senao"></block>
        </category>
        <category name="Tarefas" colour="180">
            <block type="nqc_tarefa_principal"></block>
            <block type="nqc_tarefa_nomeada"></block>
        </category>
    </xml>

    <script src="custom/nqc-blocks.js"></script>
    <script>
        // Inicializar workspace do Blockly
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: {
                spacing: 25,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true
        });

        // Notificar C# que o Blockly está pronto
        console.log('[Blockly] Workspace inicializado e pronto');
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.postMessage(JSON.stringify({
                type: 'blocklyReady'
            }));
        }

        // Gerar código NQC a partir dos blocos
        function generateCode() {
            console.log('[generateCode] Iniciando geração de código NQC');
            
            if (!nqc || !nqc.nqcGenerator) {
                console.error('[generateCode] NQC generator não disponível');
                return '';
            }

            try {
                var code = nqc.nqcGenerator.workspaceToCode(workspace);
                console.log('[generateCode] Código NQC gerado:', code ? code.substring(0, 100) + '...' : 'vazio');

                // Enviar código para a aplicação C#
                if (window.chrome && window.chrome.webview) {
                    console.log('[generateCode] Enviando mensagem para C#: codeGenerated');
                    window.chrome.webview.postMessage(JSON.stringify({
                        type: 'codeGenerated',
                        code: code
                    }));
                } else {
                    console.warn('[generateCode] window.chrome.webview não disponível');
                }

                return code;
            } catch (error) {
                console.error('[generateCode] Erro ao gerar código:', error);
                return '';
            }
        }

        // Executar o código gerado (não aplicável para NQC, mas mantido para compatibilidade)
        function runCode() {
            var code = generateCode();
            console.log('[runCode] Código gerado (não executável no navegador)');
        }

        // Gerar código automaticamente quando o workspace mudar
        workspace.addChangeListener(function (event) {
            console.log('[workspace.addChangeListener] Evento:', event.type);

            if (event.type === Blockly.Events.BLOCK_CHANGE ||
                event.type === Blockly.Events.BLOCK_CREATE ||
                event.type === Blockly.Events.BLOCK_DELETE ||
                event.type === Blockly.Events.BLOCK_MOVE) {

                console.log('[workspace.addChangeListener] Gerando código e notificando C#...');
                generateCode();
            }
        });

        // Carregar workspace a partir de XML
        function loadWorkspaceFromXml(xmlText) {
            console.log('[loadWorkspaceFromXml] Iniciando carregamento...');
            console.log('[loadWorkspaceFromXml] XML recebido:', xmlText ? xmlText.substring(0, 100) + '...' : 'vazio');

            try {
                // Desabilitar eventos durante o carregamento para evitar marcação como modificado
                Blockly.Events.disable();

                workspace.clear();
                console.log('[loadWorkspaceFromXml] Workspace limpo');

                if (xmlText && xmlText.trim() !== '') {
                    console.log('[loadWorkspaceFromXml] Convertendo XML para DOM...');
                    var xml = Blockly.utils.xml.textToDom(xmlText);
                    console.log('[loadWorkspaceFromXml] XML convertido, carregando no workspace...');
                    Blockly.Xml.domToWorkspace(xml, workspace);
                    console.log('[loadWorkspaceFromXml] Workspace carregado com sucesso!');
                    console.log('[loadWorkspaceFromXml] Blocos carregados:', workspace.getAllBlocks(false).length);
                } else {
                    console.log('[loadWorkspaceFromXml] XML vazio, workspace permanece limpo');
                }

                // Reabilitar eventos
                Blockly.Events.enable();

                return true;
            } catch (e) {
                console.error('[loadWorkspaceFromXml] Erro ao carregar workspace:', e);
                console.error('[loadWorkspaceFromXml] Stack trace:', e.stack);

                // Reabilitar eventos mesmo em caso de erro
                Blockly.Events.enable();

                return false;
            }
        }

        // Função para obter o código NQC gerado (chamada do C#)
        function getGeneratedCode() {
            console.log('[getGeneratedCode] Função chamada');
            return generateCode();
        }

        console.log('[Blockly] Workspace inicializado e pronto');
    </script>
</body>
</html>
